/*
 * This Java source file was generated by the Gradle 'init' task.
 */
package crud.java;

import java.sql.Connection;
import java.sql.DatabaseMetaData;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.Scanner;
import java.util.List;


public class App {

    private DbConnector dbCon;
    private List<String> dbTables;

    // DB Metadata

    protected List<String> getDbTables(Connection connection) {
        this.dbTables = new ArrayList<String>();
        try {
            // Aborts if connection is closed
            if (connection.isClosed()) {
                return null;
            }
            // Gets an array of strings, where each string is the name of a database table
            DatabaseMetaData dbMeta = connection.getMetaData();

            String catalog = this.dbCon.getConProps().getProperty("db.name");
            String schemaPattern = null;
            String tableNamePattern = null;
            String[] types = { "TABLE" };

            ResultSet dbTablesSet = dbMeta.getTables(catalog, schemaPattern, tableNamePattern, types);

            this.dbTables = this.resultSetToList(dbTablesSet, "TABLE_NAME");
        } catch (SQLException e) {
            System.out.println(e.getMessage());
        }

        return this.dbTables;
    }

    protected List<String> getTableColNames(int iTable) {
        List<String> tableColsNames = new ArrayList<String>();
        try {
            ResultSet tableColsSet = this.getTableColsSet(iTable);
            tableColsNames = this.resultSetToList(tableColsSet, "COLUMN_NAME");
        } catch (SQLException e) {
            System.out.println(e.getMessage());
        }

        return tableColsNames;
    }

    protected List<String> getTableColTypes(int iTable) {
        List<String> tableColsTypes = new ArrayList<String>();
        try {
            ResultSet tableColsSet = this.getTableColsSet(iTable);
            tableColsTypes = this.resultSetToList(tableColsSet, "TYPE_NAME");
        } catch (SQLException e) {
            System.out.println(e.getMessage());
        }

        return tableColsTypes;
    }

    protected List<String> getTableColSizes(int iTable) {
        List<String> tableColsTypes = new ArrayList<String>();
        try {
            ResultSet tableColsSet = this.getTableColsSet(iTable);
            tableColsTypes = this.resultSetToList(tableColsSet, "COLUMN_SIZE");
        } catch (SQLException e) {
            System.out.println(e.getMessage());
        }

        return tableColsTypes;
    }

    // DB Metadata - util

    protected ResultSet getTableColsSet(int iTable) throws SQLException{
        ResultSet tableColsSet = null;
        try {
            DatabaseMetaData dbMeta = this.dbCon.getCon().getMetaData();

            String catalog = this.dbCon.getConProps().getProperty("db.name");
            String schemaPattern = null;
            String tableNamePattern = this.dbTables.get(iTable);
            String columnNamePattern = null;

            tableColsSet = dbMeta.getColumns(catalog, schemaPattern, tableNamePattern, columnNamePattern);
        } catch (SQLException e) {
            System.out.println(e.getMessage());
        }

        return tableColsSet;
    }

    protected List<String> resultSetToList(ResultSet resultSet, String resultId) throws SQLException {
        ArrayList<String> resultList = new ArrayList<String>();
        resultSet.beforeFirst();
        while (resultSet.next()) {
            resultList.add(resultSet.getString(resultId));
        }

        return resultList;
    }

    // CLI - Main Menu

    protected void runMainMenu(Scanner cliSc) {
        int input = 0;
        do {
            this.displayMainMenu();
            System.out.print("Enter your choice: ");
            input = cliSc.nextInt();
            if (input != 0) {
                this.runCrudMenu(cliSc, input-1);
                input = cliSc.nextInt();
            }
        } while (input != 0);
    }

    protected void displayMainMenu() {
        System.out.println("\nChoose one of the following tables by number to perform operations on or enter '0' to quit.");
        System.out.println("\t0: QUIT");
        for (int i = 0; i < this.dbTables.size(); i++) {
            System.out.println("\t" + (i+1) + ": " + this.dbTables.get(i));
        }
    }

    // CLI - Crud Menu

    protected void runCrudMenu(Scanner cliSc, int iTable) {
        int crudInput = 0;
        do {
            displayCrudMenu(this.dbTables.get(iTable));
            System.out.print("Enter your choice: ");
            crudInput = cliSc.nextInt();
            switch (crudInput) {
                case 1:
                    this.create(cliSc, iTable);
                    break;
                case 2:
                    this.read(iTable);
                    break;
                case 3:
                    this.update(iTable);
                    break;
                case 4:
                    this.delete(iTable);
                    break;
                default:
                    break;
            }
        } while (crudInput != 0);
    }

    protected void displayCrudMenu(String tableName) {
        System.out.println(String.format("\nWhich operation would you like to perform on table '%s'?", tableName));
        System.out.println("\t0: BACK TO MAIN MENU");
        System.out.println("\t1: Create Item");
        System.out.println("\t2: Read Item");
        System.out.println("\t3: Update Item");
        System.out.println("\t4: Delete Item");
    }

    // CRUD

    String createTemplate = "INSERT INTO %s (%s) VALUES (%s)";

    protected void create(Scanner cliSc, int iTable) {
        String tableName = this.dbTables.get(iTable);
        List<String> tableColsNames = this.getTableColNames(iTable);
        List<String> tableColsTypes = this.getTableColTypes(iTable);
        List<String> tableColsSizes = this.getTableColSizes(iTable);
        List<String> values = this.getInsertValues(cliSc, tableColsNames, tableColsTypes, tableColsSizes);
    }

    String colDisplayTemplate = "%s - %s[%s]: ";

    protected List<String> getInsertValues(Scanner cliSc, List<String> tableColsNames, List<String> tableColsTypes, List<String> tableColsSizes) {
        ArrayList<String> values = new ArrayList<String>();
        System.out.println("Enter the values of the new item.");
        for (int i = 0; i < tableColsNames.size() && i < tableColsTypes.size(); i++) {
            String colName = tableColsNames.get(i);
            String colType = tableColsTypes.get(i);
            String colSize = tableColsSizes.get(i);
            System.out.print(String.format(colDisplayTemplate, colName, colType, colSize));
            String value = cliSc.next();
            values.add(value);
        }

        return values;
    }

    protected void read(int iTable) {
        
    }

    protected void update(int iTable) {
        
    }

    protected void delete(int iTable) {
        
    }

    private void run() {
        this.dbCon = new DbConnector();
        this.getDbTables(this.dbCon.getCon());

        Scanner cliSc = new Scanner(System.in);
        this.runMainMenu(cliSc);
        cliSc.close();

        this.dbCon.closeDbConnection();
    }

    public static void main(String[] args) {
        System.out.println("Welcome to my CRUD-Java CLI tool!");
        App app = new App();
        app.run();
    }
}
